<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>拡張デモ: エスケープコードと便利な機能の統合</title>
  <style>
    :root {
      --background-color: #fff;
      --text-color: #333;
      --border-color: #ccc;
      --pre-background: #f9f9f9;
    }
    .dark-theme {
      --background-color: #2e2e2e;
      --text-color: #eee;
      --border-color: #555;
      --pre-background: #444;
    }
    body {
      background-color: var(--background-color);
      color: var(--text-color);
      font-family: Arial, sans-serif;
      padding: 20px;
      line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
    }
    .section { 
      border: 1px solid var(--border-color); 
      padding: 15px; 
      margin-bottom: 20px; 
    }
    pre { 
      background-color: var(--pre-background); 
      padding: 10px; 
      overflow-x: auto; 
    }
    textarea { width: 100%; height: 100px; padding: 5px; }
    button { margin-top: 10px; padding: 5px 10px; }
    h2 { color: var(--text-color); }
    .btn-group {
      margin-top: 10px;
    }
    .copy-btn {
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <button onclick="toggleTheme()">ダーク/ライト切り替え</button>
  <h1>拡張デモ: エスケープコードと便利な機能の統合</h1>
  
  <!-- Section 1: コードスニペット共有 -->
  <div class="section" id="snippet-sharing">
    <h2>1. コードスニペット共有</h2>
    <p>
      コードを入力すると、エスケープされたコードとして下に表示されます。ユーザーが安全にコードを投稿・共有できます。
    </p>
    <textarea id="shareInput" placeholder="ここにコードを入力してください"></textarea>
    <div class="btn-group">
      <button onclick="shareCode()">コードを共有する</button>
      <button onclick="clearInput('shareInput', 'shareOutput')">リセット</button>
    </div>
    <div id="shareOutput"></div>
  </div>
  
  <!-- Section 2: オンラインセキュリティチュートリアル -->
  <div class="section" id="security-tutorial">
    <h2>2. HTMLエスケープの重要性セミナー</h2>
    <p>
      HTMLエスケープは、悪意あるコードの注入を防ぐための基本技術です。実例を比較して、セキュリティ面の重要性を理解しましょう。
    </p>
    <h3>生のコードの例</h3>
    <div style="border:1px dashed var(--border-color); padding: 10px;">
      <script>
        document.write("これは実行されるコードです。");
      </script>
    </div>
    <h3>エスケープされたコードの例</h3>
    <pre>&lt;script&gt;document.write("これは実行されるコードです。");&lt;/script&gt;</pre>
  </div>

  <!-- Section 3: リアルタイムコード比較ツール -->
  <div class="section" id="code-comparison">
    <h2>3. リアルタイムコード比較ツール</h2>
    <p>
      入力されたコードの実行結果とエスケープされたソース表示をリアルタイムで比較できます。
    </p>
    <textarea id="compareInput" placeholder="ここにコードを入力してください" oninput="compareCode()"></textarea>
    <div class="btn-group">
      <button onclick="clearInput('compareInput', 'renderOutput', 'escapeOutput')">リセット</button>
    </div>
    <h3>実行版 (レンダリング結果)：</h3>
    <div id="renderOutput" style="border:1px solid var(--border-color); padding:10px;"></div>
    <button class="copy-btn" onclick="copyToClipboard('renderOutput')">コピー実行結果</button>
    <h3>エスケープ版 (ソース表示)：</h3>
    <pre id="escapeOutput"></pre>
    <button class="copy-btn" onclick="copyToClipboard('escapeOutput', true)">コピーエスケープ版</button>
  </div>

  <!-- Section 4: 自動エスケープ・セキュリティ診断ツール -->
  <div class="section" id="security-diagnostic">
    <h2>4. 自動エスケープ・セキュリティ診断ツール</h2>
    <p>
      入力されたコードに潜む危険性を検出します。簡易診断で、&lt;script&gt; タグやインラインイベントハンドラなどの危険なパターンに警告を表示します。
    </p>
    <textarea id="securityInput" placeholder="コードを入力してください"></textarea>
    <div class="btn-group">
      <button onclick="diagnoseSecurity()">診断する</button>
      <button onclick="clearInput('securityInput', 'diagnosisOutput')">リセット</button>
    </div>
    <div id="diagnosisOutput" style="margin-top:10px; white-space: pre-wrap;"></div>
  </div>

  <!-- Section 5: ライブプレゼンテーション用デモツール -->
  <div class="section" id="live-demo">
    <h2>5. ライブプレゼンテーション用デモツール</h2>
    <p>
      実行版とエスケープ版をトグル切り替え。プレゼンテーションでコードの動作とソースを交互に表示できます。
    </p>
    <button onclick="toggleLiveDemo()">表示モードを切り替える</button>
    <div id="liveDemoContainer" style="margin-top: 15px;">
      <div id="liveExecuted">
        <h3>実行版</h3>
        <div id="liveExecutedContent" style="border:1px solid var(--border-color); padding: 10px;">
          <p>これは実行されたコードの例です。</p>
        </div>
        <button class="copy-btn" onclick="copyToClipboard('liveExecutedContent')">コピー実行版</button>
      </div>
      <div id="liveEscaped" style="display:none">
        <h3>エスケープ版</h3>
        <pre id="liveEscapedContent">&lt;p&gt;これは実行されたコードの例です。&lt;/p&gt;</pre>
        <button class="copy-btn" onclick="copyToClipboard('liveEscapedContent', true)">コピーエスケープ版</button>
      </div>
    </div>
  </div>

  <!-- Section 6: WebベースIDEデモ -->
  <div class="section" id="ide-demo">
    <h2>6. WebベースIDEデモ</h2>
    <p>
      入力と同時に実行結果とエスケープされたソースコードを表示する簡易オンラインIDE。  
      入力内容は自動保存され、ページ再訪時に復元します。また、コードの内容をテキストファイルとしてダウンロードできます。
    </p>
    <textarea id="ideInput" placeholder="ここにコードを入力してください" oninput="idePreview(); autoSave('ideInput')"></textarea>
    <div class="btn-group">
      <button onclick="downloadCode('ideInput')">コードをダウンロード</button>
      <button onclick="clearInput('ideInput', 'ideOutput', 'ideSourceOutput')">リセット</button>
    </div>
    <h3>実行結果</h3>
    <div id="ideOutput" style="border:1px solid var(--border-color); padding:10px;"></div>
    <button class="copy-btn" onclick="copyToClipboard('ideOutput')">コピー実行結果</button>
    <h3>ソースコード (エスケープ版)</h3>
    <pre id="ideSourceOutput"></pre>
    <button class="copy-btn" onclick="copyToClipboard('ideSourceOutput', true)">コピーエスケープ版</button>
  </div>

  <script>
    // HTMLエスケープ用のヘルパー関数
    function escapeHtml(unsafe) {
      if (!unsafe) return "";
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // 1. コードスニペット共有機能
    function shareCode() {
      var input = document.getElementById('shareInput').value;
      var escaped = escapeHtml(input);
      document.getElementById('shareOutput').innerHTML = "<pre>" + escaped + "</pre>" +
        '<button class="copy-btn" onclick="copyText(\'' + encodeURIComponent(escaped) + '\')">コピー</button>';
    }

    // 3. リアルタイムコード比較ツールの処理
    function compareCode() {
      var input = document.getElementById('compareInput').value;
      document.getElementById('renderOutput').innerHTML = input;
      document.getElementById('escapeOutput').textContent = escapeHtml(input);
    }

    // 4. 自動エスケープ・セキュリティ診断
    function diagnoseSecurity() {
      var input = document.getElementById('securityInput').value;
      var diagnosis = "";
      // <script>タグのチェック
      if(input.match(/<script[\s\S]*?>[\s\S]*?<\/script>/i)) {
        diagnosis += "警告: 入力に <script> タグが含まれています。エスケープが必要です。\n";
      }
      // インラインイベントハンドラのチェック (例: onclick=)
      if(input.match(/on\w+\s*=/i)) {
        diagnosis += "警告: インラインイベントハンドラが検出されました。セキュリティ上のリスクがあります。\n";
      }
      if(diagnosis === "") {
        diagnosis = "入力されたコードには大きな問題は見受けられません。";
      }
      document.getElementById('diagnosisOutput').textContent = diagnosis;
    }

    // 共通のリセット関数（引数に指定したIDの要素をクリア）
    function clearInput() {
      for (let i = 0; i < arguments.length; i++) {
        let element = document.getElementById(arguments[i]);
        if (element.tagName === "TEXTAREA") {
          element.value = "";
        } else {
          element.innerHTML = "";
          element.textContent = "";
        }
      }
    }

    // 5. ライブデモ用の表示モード切替
    function toggleLiveDemo() {
      var executed = document.getElementById('liveExecuted');
      var escaped = document.getElementById('liveEscaped');
      if(executed.style.display === "none") {
          executed.style.display = "block";
          escaped.style.display = "none";
      } else {
          executed.style.display = "none";
          escaped.style.display = "block";
      }
    }

    // 6. IDEプレビュー機能
    function idePreview() {
      var input = document.getElementById('ideInput').value;
      document.getElementById('ideOutput').innerHTML = input;
      document.getElementById('ideSourceOutput').textContent = escapeHtml(input);
    }

    // 指定した要素の内容をコピーする関数
    function copyToClipboard(elementId, isPreformatted) {
      var element = document.getElementById(elementId);
      var text = isPreformatted ? element.textContent : element.innerText;
      navigator.clipboard.writeText(text).then(() => {
        alert("コピーしました！");
      }, () => {
        alert("コピーに失敗しました。");
      });
    }
    
    // シェアの部分用のコピー（エスケープされた文字列）関数
    function copyText(escaped) {
      let text = decodeURIComponent(escaped);
      navigator.clipboard.writeText(text).then(() => {
        alert("コピーしました！");
      }, () => {
        alert("コピーに失敗しました。");
      });
    }
    
    // テーマ切替用の関数（ダーク/ライト）
    function toggleTheme() {
      document.body.classList.toggle('dark-theme');
    }
    
    // IDE入力の自動保存（ローカルストレージ）
    function autoSave(inputId) {
      var code = document.getElementById(inputId).value;
      localStorage.setItem('savedCode', code);
    }
    
    // ページロード時に自動保存したコードを復元
    document.addEventListener("DOMContentLoaded", function() {
      var savedCode = localStorage.getItem('savedCode');
      if(savedCode) {
        document.getElementById('ideInput').value = savedCode;
        idePreview();
      }
    });
    
    // IDEのコードをテキストファイルとしてダウンロード
    function downloadCode(inputId) {
      var code = document.getElementById(inputId).value;
      var blob = new Blob([code], { type: 'text/plain' });
      var link = document.createElement('a');
      link.href = window.URL.createObjectURL(blob);
      link.download = "code.txt";
      link.click();
    }
  </script>
</body>
</html>
